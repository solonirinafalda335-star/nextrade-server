<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interface Admin - NexTrade</title>
  <style>
    body {
      background-color: #0f172a;
      color: #f1f5f9;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
    }
    input, select {
      margin: 0.5rem 0;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #475569;
      width: 250px;
      background-color: #1e293b;
      color: #f1f5f9;
      outline: none;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #38bdf8;
    }
    button {
      background: linear-gradient(to right, #38bdf8, #0ea5e9);
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      margin-top: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: linear-gradient(to right, #0ea5e9, #38bdf8);
    }
    .section {
      margin-top: 2rem;
      width: 100%;
      max-width: 700px;
    }
    #result, #listeCodes, #listeUsers, #loginResult {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #1e293b;
      border: 1px solid #475569;
      border-radius: 12px;
      width: 100%;
      color: #f1f5f9;
      font-size: 0.95rem;
      min-height: 40px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #475569;
      text-align: left;
      color: #f1f5f9;
      font-size: 0.9rem;
    }
    th {
      background-color: #1c2a48;
    }
    h1, h2 {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>üîê Interface Admin - NexTrade</h1>

  <!-- Formulaire de connexion admin -->
  <div id="loginSection" class="section">
    <input id="adminUsername" type="text" placeholder="Nom d'utilisateur admin" autocomplete="username" />
    <input id="adminPassword" type="password" placeholder="Mot de passe admin" autocomplete="current-password" />
    <button id="btnLogin">Se connecter</button>
    <div id="loginResult"></div>
  </div>

  <!-- Section admin (masqu√©e tant que pas connect√©) -->
  <div id="adminSection" class="section" style="display:none;">
    <h2>G√©n√©rer un code</h2>
    <input id="adminKey" type="password" placeholder="Cl√© admin (admin123)" />
    <select id="offre">
      <option value="">-- Choisir une offre --</option>
      <option value="Bronze">Bronze</option>
      <option value="Argent">Argent</option>
      <option value="Gold">Gold</option>
    </select>
    <input id="duree" type="number" placeholder="Dur√©e en jours" min="1" />
    <button id="btnGenerer">G√©n√©rer</button>
    <div id="result"></div>

    <h2>üìã Codes g√©n√©r√©s</h2>
    <button id="btnRefreshCodes">üîÑ Actualiser les codes</button>
    <div id="listeCodes">Chargement des codes...</div>

    <h2>üë§ Utilisateurs inscrits</h2>
    <button id="btnRefreshUsers">üîÑ Actualiser les utilisateurs</button>
    <div id="listeUsers">Chargement des utilisateurs...</div>
  </div>

  <script>
    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginResult = document.getElementById('loginResult');
    const resultDiv = document.getElementById('result');
    const listeCodesDiv = document.getElementById('listeCodes');
    const listeUsersDiv = document.getElementById('listeUsers');

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      loginResult.textContent = "‚è≥ V√©rification...";

      if (!username || !password) {
        loginResult.textContent = "‚ùå Merci de remplir tous les champs.";
        return;
      }

      try {
        const res = await fetch('https://nextrade-server.onrender.com/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (data.success) {
          loginResult.textContent = "‚úÖ Connexion r√©ussie.";
          loginSection.style.display = 'none';
          adminSection.style.display = 'block';
          chargerCodes();
          chargerUsers();
        } else {
          loginResult.textContent = "‚ùå Identifiants incorrects.";
        }
      } catch (error) {
        loginResult.textContent = "‚ùå Erreur serveur.";
        console.error(error);
      }
    });

    document.getElementById('btnGenerer').addEventListener('click', async () => {
      const adminKey = document.getElementById('adminKey').value.trim();
      const offre = document.getElementById('offre').value;
      const duree = parseInt(document.getElementById('duree').value);
      resultDiv.textContent = "‚è≥ G√©n√©ration en cours...";

      if (!adminKey || !offre || !duree || duree <= 0) {
        resultDiv.textContent = "‚ùå Veuillez remplir tous les champs correctement.";
        return;
      }

      try {
        const res = await fetch('https://nextrade-server.onrender.com/generer-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminKey, offre, duree })
        });
        const data = await res.json();

        if (data.success) {
          resultDiv.innerHTML = `
            ‚úÖ Code g√©n√©r√© : <strong>${data.code}</strong><br>
            Offre : ${data.offre}<br>
            Expiration : ${new Date(data.expiration).toLocaleDateString()}
          `;
          chargerCodes();
        } else {
          resultDiv.textContent = `‚ùå Erreur : ${data.message}`;
        }
      } catch (error) {
        resultDiv.textContent = "‚ùå Erreur serveur lors de la g√©n√©ration.";
        console.error(error);
      }
    });

    document.getElementById('btnRefreshCodes').addEventListener('click', chargerCodes);
    document.getElementById('btnRefreshUsers').addEventListener('click', chargerUsers);

    async function chargerCodes() {
      listeCodesDiv.textContent = "‚è≥ Chargement des codes...";
      try {
        const res = await fetch('https://nextrade-server.onrender.com/liste-codes');
        const data = await res.json();

        if (data.success) {
          if (data.codes.length === 0) {
            listeCodesDiv.textContent = "Aucun code g√©n√©r√©.";
            return;
          }

          listeCodesDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Offre</th>
                  <th>Utilis√©</th>
                  <th>Expiration</th>
                </tr>
              </thead>
              <tbody>
                ${data.codes.map(code => `
                  <tr>
                    <td>${code.code}</td>
                    <td>${code.plan}</td>
                    <td>${code.is_active ? '‚úÖ Oui' : '‚ùå Non'}</td>
                    <td>${new Date(code.expiration).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          listeCodesDiv.textContent = "‚ùå Impossible de charger les codes.";
        }
      } catch (error) {
        listeCodesDiv.textContent = "‚ùå Erreur lors du chargement des codes.";
        console.error(error);
      }
    }

    async function chargerUsers() {
      listeUsersDiv.textContent = "‚è≥ Chargement des utilisateurs...";
      try {
        const res = await fetch('https://nextrade-server.onrender.com/liste-users');
        const data = await res.json();

        if (data.success) {
          if (data.users.length === 0) {
            listeUsersDiv.textContent = "Aucun utilisateur inscrit.";
            return;
          }

          listeUsersDiv.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Nom d'utilisateur</th>
                </tr>
              </thead>
              <tbody>
                ${data.users.map(user => `
                  <tr>
                    <td>${user.nom}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          listeUsersDiv.textContent = "‚ùå Impossible de charger les utilisateurs.";
        }
      } catch (error) {
        listeUsersDiv.textContent = "‚ùå Erreur lors du chargement des utilisateurs.";
        console.error(error);
      }
    }
  </script>

  <script src="popup.js"></script>
</body>
</html>
